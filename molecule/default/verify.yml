---
- name: Verify
  hosts: all
  gather_facts: false
  any_errors_fatal: true

  tasks:

    - name: "Include default vars"
      ansible.builtin.include_vars:
        dir: "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/defaults/"
        extensions: [ 'yml' ]

    - name: "Check if smartctl_exporter is installed"
      changed_when: false
      ansible.builtin.command: "smartctl_exporter --version"
      register: smartctl_exporter_installed_version

    - name: "Check smartctl_exporter version"
      ansible.builtin.assert:
        that: "smartctl_exporter_installed_version.stderr is regex('{{ smartctl_exp_version }}')"
        success_msg: "smartctl_exporter version {{ smartctl_exp_version }} is installed and working"
        fail_msg: "smartctl_exporter version {{ smartctl_exp_version }} is not installed or not working correctly"

    - name: Check if /metrics endpoint is reachable
      ansible.builtin.uri:
        url: "http://localhost:{{ smartctl_exp_port }}/metrics"
        return_content: false
        status_code: 200
        timeout: 5
      register: metrics_check
      ignore_errors: true

    - name: Fail if /metrics is unreachable
      ansible.builtin.fail:
        msg: "smartctl_exporter /metrics endpoint is not responding!"
      when: metrics_check.status != 200
